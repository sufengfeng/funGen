C51 COMPILER V9.60.0.0   UART2                                                             08/14/2020 13:40:55 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE UART2
OBJECT MODULE PLACED IN uart2.OBJ
COMPILER INVOKED BY: D:\Keil_v5\C51\BIN\C51.EXE uart2.c OPTIMIZE(8,SPEED) BROWSE INCDIR(.\SRC) DEBUG OBJECTEXTEND TABS(2
                    -)

line level    source

   1          
   2          /*---------------------------------------------------------------------*/
   3          /* --- STC MCU International Limited ----------------------------------*/
   4          /* --- STC 1T Series MCU Demo Programme -------------------------------*/
   5          /* --- Mobile: (86)13922805190 ----------------------------------------*/
   6          /* --- Fax: 86-0513-55012956,55012947,55012969 ------------------------*/
   7          /* --- Tel: 86-0513-55012928,55012929,55012966 ------------------------*/
   8          /* --- Web: www.GXWMCU.com --------------------------------------------*/
   9          /* --- QQ:  800003751 -------------------------------------------------*/
  10          /* 如果要在程序中使用此代码,请在程序中注明使用了宏晶科技的资料及程序   */
  11          /*---------------------------------------------------------------------*/
  12          
  13          
  14          #define MAIN_Fosc   24000000UL  //定义主时钟
  15          
  16          #include  "STC15Fxxxx.H"
  17          
  18          #define   Baudrate2 115200L
  19          
  20          
  21          
  22          /*************  功能说明  **************
  23          
  24          双串口全双工中断方式收发通讯程序。
  25          
  26          通过PC向MCU发送数据, MCU收到后通过串口把收到的数据原样返回.
  27          
  28          ******************************************/
  29          
  30          
  31          #define UART2_BUF_LENGTH  32
  32          
  33          
  34          
  35          u8  TX2_Cnt;  //发送计数
  36          u8  RX2_Cnt;  //接收计数
  37          bit B_TX2_Busy; //发送忙标志
  38          
  39          u8  idata RX2_Buffer[UART2_BUF_LENGTH]; //接收缓冲
  40          
  41          
  42          void  UART2_config(u8 brt); // 选择波特率, 2: 使用Timer2做波特率, 其它值: 无效.
  43          void  PrintString2(u8 *puts);
  44          
  45          
  46          
  47          //========================================================================
  48          // 函数: void main(void)
  49          // 描述: 主函数。
  50          // 参数: none.
  51          // 返回: none.
  52          // 版本: VER1.0
  53          // 日期: 2014-11-28
  54          // 备注: 
C51 COMPILER V9.60.0.0   UART2                                                             08/14/2020 13:40:55 PAGE 2   

  55          //========================================================================
  56          void maint3(void)
  57          {
  58   1        P0M1 = 0; P0M0 = 0; //设置为准双向口
  59   1        P1M1 = 0; P1M0 = 0; //设置为准双向口
  60   1        P2M1 = 0; P2M0 = 0; //设置为准双向口
  61   1        P3M1 = 0; P3M0 = 0; //设置为准双向口
  62   1        P4M1 = 0; P4M0 = 0; //设置为准双向口
  63   1        P5M1 = 0; P5M0 = 0; //设置为准双向口
  64   1        P6M1 = 0; P6M0 = 0; //设置为准双向口
  65   1        P7M1 = 0; P7M0 = 0; //设置为准双向口
  66   1      
  67   1      
  68   1        UART2_config(2);  // 选择波特率, 2: 使用Timer2做波特率, 其它值: 无效.
  69   1        EA = 1; //允许全局中断
  70   1        
  71   1        PrintString2("STC15F2K60S2 UART2 Test Prgramme!\r\n");  //SUART2发送一个字符串
  72   1      
  73   1        while (1)
  74   1        {
  75   2          if((TX2_Cnt != RX2_Cnt) && (!B_TX2_Busy)) //收到数据, 发送空闲
  76   2          {
  77   3            S2BUF = RX2_Buffer[TX2_Cnt];
  78   3            B_TX2_Busy = 1;
  79   3            if(++TX2_Cnt >= UART2_BUF_LENGTH) TX2_Cnt = 0;
  80   3          }
  81   2        }
  82   1      }
  83          
  84          
  85          //========================================================================
  86          // 函数: void PrintString2(u8 *puts)
  87          // 描述: 串口2发送字符串函数。
  88          // 参数: puts:  字符串指针.
  89          // 返回: none.
  90          // 版本: VER1.0
  91          // 日期: 2014-11-28
  92          // 备注: 
  93          //========================================================================
  94          void PrintString2(u8 *puts)
  95          {
  96   1          for (; *puts != 0;  puts++)     //遇到停止符0结束
  97   1        {
  98   2          S2BUF = *puts;
  99   2          B_TX2_Busy = 1;
 100   2          while(B_TX2_Busy);
 101   2        }
 102   1      }
 103          
 104          //========================================================================
 105          // 函数: SetTimer2Baudraye(u16 dat)
 106          // 描述: 设置Timer2做波特率发生器。
 107          // 参数: dat: Timer2的重装值.
 108          // 返回: none.
 109          // 版本: VER1.0
 110          // 日期: 2014-11-28
 111          // 备注: 
 112          //========================================================================
 113          void  SetTimer2Baudraye(u16 dat)  // 选择波特率, 2: 使用Timer2做波特率, 其它值: 使用Timer1做波特率.
 114          {
 115   1        AUXR &= ~(1<<4);  //Timer stop
 116   1        AUXR &= ~(1<<3);  //Timer2 set As Timer
C51 COMPILER V9.60.0.0   UART2                                                             08/14/2020 13:40:55 PAGE 3   

 117   1        AUXR |=  (1<<2);  //Timer2 set as 1T mode
 118   1        TH2 = dat / 256;
 119   1        TL2 = dat % 256;
 120   1        IE2  &= ~(1<<2);  //禁止中断
 121   1        AUXR |=  (1<<4);  //Timer run enable
 122   1      }
 123          
 124          //========================================================================
 125          // 函数: void UART2_config(u8 brt)
 126          // 描述: UART2初始化函数。
 127          // 参数: brt: 选择波特率, 2: 使用Timer2做波特率, 其它值: 无效.
 128          // 返回: none.
 129          // 版本: VER1.0
 130          // 日期: 2014-11-28
 131          // 备注: 
 132          //========================================================================
 133          void  UART2_config(u8 brt)  // 选择波特率, 2: 使用Timer2做波特率, 其它值: 无效.
 134          {
 135   1        /*********** 波特率固定使用定时器2 *****************/
 136   1        if(brt == 2)
 137   1        {
 138   2          SetTimer2Baudraye(65536UL - (MAIN_Fosc / 4) / Baudrate2);
 139   2      
 140   2          S2CON &= ~(1<<7); // 8位数据, 1位起始位, 1位停止位, 无校验
 141   2          IE2   |= 1;     //允许中断
 142   2          S2CON |= (1<<4);  //允许接收
 143   2          P_SW2 &= ~0x01; 
 144   2          P_SW2 |= 1;     //UART2 switch to: 0: P1.0 P1.1,  1: P4.6 P4.7
 145   2      
 146   2          B_TX2_Busy = 0;
 147   2          TX2_Cnt = 0;
 148   2          RX2_Cnt = 0;
 149   2        }
 150   1      }
 151          
 152          /*终端接收串口屏数据*/
 153          void UART2_int (void) interrupt UART2_VECTOR
 154          {
 155   1        if((S2CON & 1) != 0)
 156   1        {
 157   2          S2CON &= ~1;  //Clear Rx flag
 158   2          RX2_Buffer[RX2_Cnt] = S2BUF;
 159   2          if(++RX2_Cnt >= UART2_BUF_LENGTH) RX2_Cnt = 0;
 160   2        }
 161   1      
 162   1        if((S2CON & 2) != 0)
 163   1        {
 164   2          S2CON &= ~2;  //Clear Tx flag
 165   2          B_TX2_Busy = 0;
 166   2        }
 167   1      
 168   1      }
 169          
 170          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    227    ----
   CONSTANT SIZE    =     36    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      2    ----
C51 COMPILER V9.60.0.0   UART2                                                             08/14/2020 13:40:55 PAGE 4   

   IDATA SIZE       =     32    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
